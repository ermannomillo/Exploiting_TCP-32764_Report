# UniTS Cybersecurity (436MI) Report: Exploiting the TCP/32764 Vulnerability in Legacy Netgear Wireless Routers for DNS Hijacking


&nbsp;

<div align="left">
	
  Trieste, 5th May 2024
  
  Nicolò Ermanno Millo
  
</div>

&nbsp;

## Introduction

In this document, I will demostrate how to accomplish a DNS hijacking attack againt endpoints connected to compromised Netgear DG834Gv3 wireless router.


## Threat Model

To align the report with a real scenario, the following threat model is considered throughout the entire document:

Given an operational Netgear DG834Gv3 wireless router, it is assumed that the attacker has the capability to connect to the same LAN managed by the router.

## Reconnaissance

Generally, even before connecting to an access point, it is possible to visually inspect the physical device and recognize its model. If not, it is still possible to gather the same information using specialized software tools, one among all, Nmap.

&nbsp;

![The Markdown Mark](images/nmap.PNG)  
_Figure 1: Nmap command execution for detecting OS of wireless router[^5]._

&nbsp;

This very approach is not encouraged because it is noisy in terms of network traffic, making it more detectable. In fact, Nmap, to complete the OS detection, sends more than 1000 TCP packets to the device. This is a considerable amount of traffic, especially considering that the gathered information may not be complete. 

While the OS and manufacturer can be identified, the model remains unknown, which is the most crucial piece of information.

[^5]: https://nmap.org/book/osdetect-usage.html#osdetect-ex-scanme1

Another way to obtain the desired information is to observe and interact with the services provided by the device. 
Executed Nmap command supported this method, having detected an HTTP service on port 80, a likely admin web panel. Anyway the same service could be found also by guesses.

&nbsp;

![The Markdown Mark](images/adminpanel.PNG)  
_Figure 2: Unauthorized access to HTTP service, beside the HTML code of the webpage._

&nbsp;

Within the HTML of the page, there is a meta tag "description" that discloses what is being searched for. The device is identified as a wireless router (+ switch + modem) of the Netgear DG384* series. Although the precise model remains unknown, it is absolutely not necessary for this purpose.

This last approach appears to be less detectable, as network traffic is reduced and more conventional. However, it's worth think over that after a failed authentication attempt on the admin panel, a notification could be sendto the administrator. 

At the current phase of the attack, this uncertainty cannot be addressed.

## Backdoor unveiling

When it was determined that we are connected to a Netgear DG834G* device, it might be planned to exploit an hidden backdoor.

This device, like many other systems based on Sercomm modem, exposes a backdoor that can be exploited to gain administrative rights and manipulate local network resources without admin credentials [^2]. Interestingly, it is not a mistake in itself, but rather an arbitrary hidden functionality (CWE-912)[^1], probably part of a legacy Sercomm updating tool.

These claims are supported by the fact that after the vulnerability disclosure, the subsequent firmware patches did not close the backdoor but instead merely hid it[^5]. Even today, it can be reactivated by sending a proper Ethernet packet[^3].

[^1]: “NETGEAR ROUTER DG/DGN/DM/JNR/WPNT PORT TCP/32764 BACKDOOR”, VulDB, https://vuldb.com/?id.11715 (accessed Apr. 21, 2024). 
[^3]: J. Ullrich , “Port 32764 router backdoor is back (or was it ever gone?) ,” SANS Technology Institute - Internet Storm Center, https://isc.sans.edu/diary/Port+32764+Router+Backdoor+is+Back+or+was+it+ever+gone/18009 (accessed Apr. 21, 2024). 
[^5]: E. Vanderbeken, "How Sercomm saved my Easter! Another backdoor in my router: when Christmas is NOT enough!", Synactiv, https://www.synacktiv.com/ressources/TCP32764_backdoor_again.pdf (accessed Apr. 21, 2024). 

None comments on these facts was released by Sercomm and Netgear[^2].

[^2]: S. Gallagher, “Easter egg: DSL router patch merely hides backdoor instead of closing it”, Ars Technica, https://arstechnica.com/information-technology/2014/04/easter-egg-dsl-router-patch-merely-hides-backdoor-instead-of-closing-it/ (accessed Apr. 21, 2024).

### Exploit and payload

Interaction with the backdoor is based on a TCP-based undocumented protocol. Eloi Vanderbeken at Synactiv successfully reverse-engineered it using IDA Pro[^6]. Once understood the functioning of the protocol and it was discovered that it may be exploited in order to open a root associated remote shell, a Python Proof-of-Concept (PoC) and a Metasploit module were developed. 

[^6]: E. Vanderbeken, "TCP/32764 backdoor Or how linksys saved christmas!", Github, https://github.com/elvanderb/TCP-32764/blob/master/backdoor_description_for_those_who_don-t_like_pptx.pdf (accessed Apr. 21, 2024). 

There are significant differences between them.

- The PoC was specifically developed for the Linksys WAG200G wireless router, however, it effectively works for the Netgear DG834Gv3 as well. Nevertheless, there are no assurances regarding compatibility with other devices.
Additionally, the script can be utilized to directly access to various Sercomm protocol methods, including a non-reversed root-associated remote shell.

- On the other hand, the Metasploit module is capable of operating with a wide range of routers and offers many different payloads, including a Linux reverse shell. A notable difference is that neither of them opens a root shell. Instead, the associated account is "nobody". This class of account is generally used as a low privilege debug account to prevent severe compromises of remote systems[^4]. Nevertheless, it seems to have read access rights almost everywhere.

[^4]:  O. Kirch, Why NFS sucks”, Suse/Novell inc., Proceedings of Ottawa Linux Symposium 2006, https://www.kernel.org/doc/ols/2006/ols2006v2-pages-59-72.pdf (accessed Apr. 21, 2024).

Despite the differences, both are based on the same protocol and TCP packets exchange is equiparable.

&nbsp;

![The Markdown Mark](images/cap_poc.PNG)  
_Figure 3: Wireshark capture of PoC-based remote shell initialization._

&nbsp;

To better understand the reason for this payload and the functioning of the protocol in general, the PoC and documentation are useful. the protocol itself is not complicated.

Wrapping up, the protocol works over TCP;  it requires a hardcoded header dictated by the router architecture, specifically endianess; the very payload is enclosed in plaintext and without any authentication or complications.

&nbsp;

```python

def send_message(s, endianness, message, payload=''):
    """
    Send a message via open TCP connection to TCP/32764 vulnerable device

    Parameters:
    s         (socket) : Description of arg1
    endianess (char)   :
    message   (int)    : Index of backdoor functionality
    payload   (string) : Textual parameters to  chosen functionality 

    Returns:
    ret_val   (string) : Returning value
    ret_str   (string) : Returning string
    """

    header = struct.pack(endianness + 'III', 0x53634D4D, message, len(payload)+1)
    s.send(header+payload+"\x00")
    r = s.recv(0xC)

    while len(r) < 0xC:
	tmp = s.recv(0xC - len(r))
	assert len(tmp) != 0
	r += tmp

	sig, ret_val, ret_len = struct.unpack(endianness + 'III', r)
	assert(sig == 0x53634D4D)

	if ret_val != 0:
		return ret_val, "ERROR"

	ret_str = ""
	while len(ret_str) < ret_len:
		tmp = s.recv(ret_len - len(ret_str))
		assert len(tmp) != 0
		ret_str += tmp

return ret_val, ret_str

# ...

# ... if/elif discriminates PoC args

elif args.shell : # Poc arg : --shell
    print(send_message(s, endianness, 7, 'echo "welcome, here is a root shell, have fun"')[1])
    while 1 :
        print(send_message(s, endianness, 7, sys.stdin.readline().strip('\n'))[1])

#...
```
&nbsp;

Code released with Beerware licence [^7]. Unique modifications concerns the added comments.
[^7]: https://github.com/elvanderb/TCP-32764/blob/master/LICENSE


## Firmware exploration

Once a shell is opened, the next logical step is to examine the functionalities and configurations of the system.

Before taking any action, and as quickly as possible, it is critical to verify the logging policy of the device. If properly configured, the mere access to the backdoor, but also the earlier reconnaissance actions performed, may generate logs and potentially would then be sent to an administrator.

&nbsp;

![The Markdown Mark](images/log.PNG)  
_Figure 4: Router confinguration files showing log policy. _

&nbsp;

Fortunately, none of the actions are registered in the logs, even though the log configuration file indicates that the strictest log policy is enabled. It is also important to note that successful accesses to the admin web panel are logged.

After having reviewed the logs, it is critical to understand which user is associated with the Linux shell and which are its access rights. Finally, it should be understood the structure of the firmware and so gather any sensitive information. 

These assessments allows the attacker to grasp the magnitude of their privilege within the system and devise a feasible attack accordingly.

&nbsp;

![The Markdown Mark](images/busy.PNG)  
_Figure 5: Programs made available by Busybox._

&nbsp;

Not surprisingly, the firmware has a considerably compact memory footprint. This aspect practically reflects on the number of programs installed on the machine. The majority of programs are made available by the Busybox software suite.

Unfortunately, the available programs are not numerous and are also quite outdated. Additionally, installing new ones is challenging. This aspect is crucial because it dictates the manner in which the system can be compromised.

&nbsp;

![The Markdown Mark](images/conf.PNG)  
_Figure 6: Sensitive configuration files._

&nbsp;

Achieving admin credentials to the web panel conceptually does not grant any more privilege than being root in the shell. However, working on HTTP is potentially less detectable because it is less anomalous.

In any case, as mentioned before, admin authentication on the web panel is logged, so the first step should be to modify syslog.conf via PoC root shell, in order to temporarily loosen the log policy.

Summing up all the information gathered, in the next section I will propose a set of feasible configuration modifications to compromise other devices attached to the router.

## Modifying system configuration

Given the limited functionalities of the device, an easily feasible modification is changing the DNS configuration to route DNS requests to an attacker-controlled DNS server. This can be configured to respond to certain DNS requests with the IP addresses of malicious web servers, potentially facilitating a MITM threat model.


&nbsp;

![The Markdown Mark](images/web.PNG)  
_Figure 7: DNS configuration page of admin web panel._

&nbsp;

With the support of the compromised router, a malicious DNS server can be setted up on an attacker machine using the bind9 service. This let associate to domain postesicure.com a local malicious website. This can be set to seems trustable enough in order to intercept sensitive information of web services, where only password is needed to authentication.

&nbsp;

![The Markdown Mark](images/dns.PNG)  
_Figure 8: Malicious webpage loaded next to DNS traffic to malicious DNS server._

To make the attack more sofisticated, the same webserver could works as a proxy, enabling the attacker to manipulate HTTP requests and responses. This not only facilitates the interception of sensitive information, but also enables the attacker to inject malicious content, besides the fact that a it is easier to wider the range of malicious website returned to victim machines.

Main problem about DNS hijacking managed in this way is surely detactability. The attacker machine and its services should keep up within a network that potentially have an implemented some even simple Network Detection and Response solution.

To deal with this scenario, it could be a good practise restrict the compromising infrastructure to the bare router. For instance, the wireless router made available iptable program, so the attack consists of devising proper routes, in order to redirect chosen traffic to external malicious server. However, it's important to note that the version of iptables on the router is considerably old, which means many more advanced functionalities may not be available.

## Reverse engineering 

Reconstructing the firmware of the router to add functionalities is indeed a straightforward way to achieve more advanced offensive techniques. This can be easily achieved through an interface within the web panel, which allows for firmware modification. However, it's important to note that this method may increase the likelihood of detection, especially if significant changes are made.

As a precaution, it's advisable to make minor changes to the firmware to reduce the risk of detection. Nonetheless, it's important to acknowledge that a reboot of the device is inevitable after firmware modification.

Modifying a genuine firmware carries high risk, even when using specialized tools such as binwalk or firmware-modkit. If the procedure fails, the consequences can range from the update being rejected due to image hash issues to rendering the device inoperable, requiring physical intervention for recovery.

## Mitigation

Exploiting TCP/32764 vulnerability is surely easy and pretty effective, as we have seen. However also the main adviced mitigation has the same properties. To preventing access to the backdoor, nothing more than firewall port 32764 is required.  

Therefore, on attacker perspective, persistency have to be employed. Probably a CGI-based webshell can be developed, once it is comprehended in deep the http service of the router.
